# Cowork - UI・システム概観

## UI構成

3ペインレイアウト：

```
┌──────────┬──────────────────┬──────────┐
│          │                  │          │
│ サイドバー │    チャット        │ アクティビティ│
│          │                  │          │
│ ・ファイル  │  メッセージ表示     │ ツール実行状況│
│ ・スキル   │  ストリーミング表示  │ （日本語翻訳）│
│ ・TODO    │                  │ ・実行中    │
│ ・設定    │  入力エリア        │ ・完了     │
│          │                  │ ・エラー    │
└──────────┴──────────────────┴──────────┘
```

- **左サイドバー**: ファイルブラウザ、スキル管理、TODOリスト、設定（Slack/GDrive）をタブ切替
- **中央チャット**: Claudeとの対話。メッセージバブル、ストリーミング表示、ウェルカム画面
- **右アクティビティ**: ツール実行の可視化。何をしているか日本語でリアルタイム表示

## 技術スタック

| レイヤー       | 技術                                              | 理由                                       |
| -------------- | ------------------------------------------------- | ------------------------------------------ |
| フレームワーク | Tauri v2                                          | 軽量、ネイティブ、Rustの安全性             |
| バックエンド   | Rust                                              | プロセス管理、ファイルI/O、APIクライアント |
| フロントエンド | React + TypeScript                                | コンポーネント設計、型安全                 |
| Claude連携     | `claude -p --output-format stream-json --verbose` | 構造化ストリーム出力                       |
| セッション継続 | `--resume` + session_id保存                       | 会話の継続性                               |
| ビルド         | pnpm, GitHub Actions                              | Windows MSI/NSISインストーラー自動生成     |

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────┐
│                  Tauri (Rust)                    │
│                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
│  │ claude.rs │  │ slack.rs │  │   gdrive.rs  │  │
│  │           │  │          │  │              │  │
│  │ CLIラップ  │  │ Lists API│  │  OAuth2+API  │  │
│  │ NDJSON解析 │  │  Bot認証  │  │  ファイル取得  │  │
│  └─────┬─────┘  └────┬─────┘  └──────┬───────┘  │
│        │             │               │          │
│  ┌─────┴─────────────┴───────────────┴───────┐  │
│  │          Tauriイベント / コマンド            │  │
│  └─────────────────────┬─────────────────────┘  │
│                        │                        │
│  ┌─────────────┐  ┌────┴─────┐  ┌───────────┐  │
│  │translator.rs│  │skills.rs │  │  todos.rs  │  │
│  │ ツール翻訳   │  │スキル管理  │  │  TODO管理  │  │
│  │ (日本語化)   │  │テンプレート │  │ ローカル永続 │  │
│  └─────────────┘  └──────────┘  └───────────┘  │
└─────────────────────────────────────────────────┘
                         │
                         ▼ Tauriイベント
┌─────────────────────────────────────────────────┐
│              React + TypeScript                  │
│                                                 │
│  ┌───────────┐ ┌────────────┐ ┌──────────────┐ │
│  │ useClaude  │ │ App.tsx    │ │ Components   │ │
│  │ (hook)     │ │ 3ペイン     │ │              │ │
│  │ イベント受信 │ │ レイアウト   │ │ ChatInput    │ │
│  │ 状態管理    │ │ タブ切替     │ │ MessageBubble│ │
│  └───────────┘ └────────────┘ │ ActivityPanel│ │
│                               │ FileBrowser  │ │
│                               │ SkillManager │ │
│                               │ TodoPanel    │ │
│                               │ SettingsPanel│ │
│                               │ ApprovalDialog│ │
│                               └──────────────┘ │
└─────────────────────────────────────────────────┘
```

## stream-jsonプロトコル

Claude Codeの `--output-format stream-json` は以下のイベントタイプをNDJSONで出力する：

- `system` - セッション情報（session_id取得）
- `assistant` - Claudeの応答（テキスト、ツール呼び出し）
- `user` - ツール実行結果（activity完了通知に使用）
- `result` - 最終結果
- `stream_event` - テキストデルタ（リアルタイムストリーミング）

これをRust側で解析し、フロントエンドにTauriイベントとして配信する：

| Tauriイベント | 用途 |
|---|---|
| `claude:message` | チャットメッセージ表示 |
| `claude:text_delta` | ストリーミングテキスト |
| `claude:activity` | ツール実行開始（日本語翻訳済み） |
| `claude:activity_done` | ツール実行完了 |
| `claude:done` | プロセス完了 |
| `claude:system` | セッション情報 |
| `claude:result` | 最終結果 |
| `claude:stderr` | エラー出力 |
